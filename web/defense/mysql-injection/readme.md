# SQLi Tests
## 0. MySQL-DB Setup

Setting up the database for SQLi-Tests
```
> CREATE DATABASE testdb;
> CREATE USER test@'%' IDENTIFIED BY 'password';
> GRANT ALL ON testdb.* TO test@'%';
> FLUSH PRIVILEGES;

> CREATE TABLE IF NOT EXISTS actors (
    id INT AUTO_INCREMENT,
    firstname VARCHAR(255) NOT NULL,
	lastname VARCHAR(255) NOT NULL,
    PRIMARY KEY (id)
)  ENGINE=INNODB;

> INSERT INTO testdb.actors (firstname,lastname) VALUES ("Bill","O'Reilly");
> INSERT INTO testdb.actors (firstname,lastname) VALUES ("George","Clooney");
> INSERT INTO testdb.actors (firstname,lastname) VALUES ("Tom","Cruise");
```

## 1. PDO Raw Query (unsafe)
### 1.1 Working example in PHP

A working example of a valid and expected input for the raw query.
```
Query: query("SELECT firstname FROM testdb.actors WHERE lastname='$input';")
[*] $input: Cruise

Result: Tom
```

## 1.2 Working SQL-Injection in PHP

A working example of a working but malicious input for the raw query.
```
Query: query("SELECT firstname FROM testdb.actors WHERE lastname='$input';")
[*] $input: ' UNION SELECT version()#

Result: 10.1.29-MariaDB-6
```

## 2. PDO Quote (safe)
### 2.1 Working example in PHP

A working example of a valid and expected, but quoted (escaped) input for the query.
```
Query: query("SELECT firstname FROM testdb.actors WHERE lastname=$_lastname;")
[*] Input: Cruise
[*] Escaped: 'Cruise'

Result: Tom
```
### 2.2 Failed SQL-Injection in PHP

A failed example of a malicious, but quoted (escaped) input for the query.
```
Query: query("SELECT firstname FROM testdb.actors WHERE lastname=$_input;")
[x] Input: 'Cruise' UNION SELECT version()
[x] Escaped: '\'Cruise\' UNION SELECT version()'

Result: 
```
## 3. PDO Stored Procedures (Safe)
### 3.1 Preparations

Setup of a simple but secure stored procedure.
```
> DELIMITER //
CREATE PROCEDURE getLastname
(IN actor VARCHAR(255))
BEGIN
  SELECT firstname FROM actors
  WHERE lastname = actor;
END //

> DELIMITER ;
```
## 3.2 Testing

Working with good input.
```
> call getLastname("Cruise");
+-----------+
| Firstname |
+-----------+
| Tom       |
+-----------+
```
Failing with bad input.
```
> call getLastname('Cruise or 1=1');
Empty set (0.00 sec)

Query OK, 0 rows affected (0.00 sec)
```
### 3.3 Working example in PHP

Working example of the secure stored procedure via PHP.
```
Query: CALL getLastnameDynamic('$input');
[*] Stored Procedure: Cruise

Result: Tom
```
### 3.4 Failed SQL-Injection in PHP
A failed example of a malicious input in a secure stored procedure.
```
Query: CALL getLastnameDynamic('$input');
[*] Stored Procedure: Cruise or 1=1

Result: 
```
## 3. PDO Dynamic Stored Procedures (Unsafe)
### 3.1 Preperations
A vulnerable example with dynamically built SQL queries in a stored procedure.
```
> delimiter // 
> CREATE PROCEDURE getLastnameDynamic(IN actor VARCHAR(255))
BEGIN
    SET @s = CONCAT('SELECT firstname FROM testdb.actors WHERE lastname="',actor,'"' );
    PREPARE stmt FROM @s;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END
//
> delimiter ;
```

### 3.2 Testing

Testing the new procedure within the mysql shellt
```
> call getLastnameDynamic('Cruise');
+-----------+
| firstname |
+-----------+
| Tom       |
+-----------+
```
An SQL-Injection example within the mysql shell
```
> call getLastnameDynamic('Cruise" or "1"="1');
+-----------+
| firstname |
+-----------+
| Bill      |
| George    |
| Tom       |
+-----------+
3 rows in set (0.00 sec)

Query OK, 0 rows affected (0.00 sec)
 ```

### 3.3 Working example with good input
```
Query: CALL getLastnameDynamic('$input');
[*] Dynamic Stored Procedure: Cruise

Result: Tom
```
### 3.4 SQL-Injection in dynamic stored procedure #1
```
Query: CALL getLastnameDynamic('$input');
[*] Dynamic Stored Procedure: Cruise" or "1"="1

Result: Bill
Result: George
Result: Tom
```
### 3.5 SQL-Injection in dynamic stored procedure #2
```
Query: CALL getLastnameDynamic('$input');
[*] Dynamic Stored Procedure: Cruise" UNION SELECT version()#

Result: Tom
```
## 4. PDO Prepared Statements (safe)
### 4.1 Statements with named variables
```
Query: $conn->prepare("SELECT firstname FROM testdb.actors where lastname = :name")
Param: $stmt->bindParam(:name, $input);
[*] Input: Cruise

Result: Tom
```
### 4.2 Statements with indexed variables
```
Query: $conn->prepare("SELECT firstname FROM testdb.actors where lastname = ?")
Param: $stmt->bindParam(1, $input);
[*] Input: Cruise

Result: Tom
```
### 4.3 Failed SQL-Injection in prepared statement
```
Query: $conn->prepare("SELECT firstname FROM testdb.actors where lastname = ?")
Param: $stmt->bindParam(1, $input);
[*] Input: Cruise or 1=1

Result: 
```
